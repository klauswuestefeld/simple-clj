<!DOCTYPE html>
<html lang="en" style="margin: 0px; padding: 0px; height: 100%">

<head>
  <meta charset="UTF-8" />
  <title>Spread</title>

  <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
  <script src="https://jsuites.net/v4/jsuites.js"></script>
  <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
  <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons" />
  <style>
    #spread {
      margin: 12px;
    }

    #spread-spreadsheet {
      padding: 10px;
      padding-right: 100px; /* Space for the user to resize the rightmost column. */
      overflow: auto;
      display: block;
    }

    details>*:not(summary) {
      margin-left: 1em;
    }

    details p {
      margin-top: 0.4rem;
      margin-bottom: 0.4rem;
    }

    .selected-test {
      background-color: blue;
      color: white;
    }
  </style>
</head>

<body style="margin: 0px; padding: 0px; height: 100%;">
  <div id="menu-div" style="display: none; width: 350px; background-color: #f5f5f5; height: 100%; float: left;">
    <div id="alert-container">
    </div>
  </div>
  <div id="spread-spreadsheet"></div>
</body>
<script>
  let jspreadsheetObj;
  let currentFilePath = null;

  function loadJSpreadsheet(spreadsheet) {
    const jspreadsheetPayload = {
      data: spreadsheet.data,
      onevent: function (event, a, b, c, d, e, f) {
        // console.log(event, a, b, c, d, e, f);
      },
      onopenworksheet: function (_worksheet, worksheetIndex) {
        removeTestStatusAlert();
      },
      oncreateworksheet: function (_event) {
        removeTestStatusAlert();
      },
      onchange: function (_event) {
        saveSpreadsheetAndRunTests();
      },
      onresizecolumn: function (_event) {
        saveSpreadsheetAndRunTests();
      },
      onresizerow: function (_event) {
        saveSpreadsheetAndRunTests();
      },
      rowResize: true,
      wordWrap: true,
    }
    if (spreadsheet?.dimensions?.columns) {
      jspreadsheetPayload.columns = spreadsheet.dimensions.columns;
    }
    if (spreadsheet?.dimensions?.rows) {
      jspreadsheetPayload.rows = spreadsheet.dimensions.rows;
    }
    jspreadsheetObj = jspreadsheet(document.getElementById("spread-spreadsheet"), jspreadsheetPayload);
  }

  function clearErrorHighlights() {
    const table = jspreadsheetObj.getData();
    for (let i = 0; i < table.length; i++) {
      for (let j = 0; j < table[i].length; j++) {
        const cellDOMElement = jspreadsheetObj.getCellFromCoords(j, i);
        cellDOMElement.style.backgroundColor = "white";
      }
    }
  }

  function displayTestStatusAlert(message, textColor) {
    const old = document.querySelector("#test-status-alert");
    old?.remove();

    const alert = document.createElement("p");
    alert.id = "test-status-alert";
    alert.textContent = message;

    if (textColor) {
      alert.style.color = textColor;
    }

    const container = document.querySelector("#alert-container");
    container.appendChild(alert);
  }

  function indicateTestsRunning() {
    displayTestStatusAlert("Running tests...");
  }

  function displayTestsPassed() {
    displayTestStatusAlert("All tests passed (Just now)", "green");
    setTimeout(() => {
      displayTestStatusAlert("All tests passed", "green")
    }, 3000);
  }

  function displayTestError(msg) {
    displayTestStatusAlert(msg, "red");
  }


  async function handleTestResponse(response) {
    if (response.ok) {
      displayTestsPassed();
    } else {
      const body = await response.json();
      if (body["ex-data"] && body["ex-data"].column) {
        const cell = body["ex-data"].column + body["ex-data"].line;

        const spreadsheetElement = document.getElementById(body["ex-data"].spreadsheet);
        await handleTestSelection(spreadsheetElement);

        const cellDOMElement = jspreadsheetObj.getCell(cell);
        cellDOMElement.style.backgroundColor = "lightpink";

        displayTestError(body.message);
      } else if (body["ex-data"] && body["ex-data"].stacktrace) {
        displayTestError("Exception\n\n" + body["ex-data"].stacktrace)
      } else {
        displayTestError(body.message);
      }
    }
  }

  async function runTests() {
    indicateTestsRunning();

    const response = await fetch("/api/run");
    await handleTestResponse(response);
  }

  function getSpreadsheetDimensions() {
    const columns = [];
    jspreadsheetObj.colgroup.forEach(col => columns.push({ width: Number(col.width) }));

    const rows = {};
    jspreadsheetObj.rows.forEach((row, i) => {
      const settedHeight = row.getAttribute('height');
      rows[i] = { height: settedHeight ? settedHeight + 'px' : '' };
    });

    return { columns, rows };
  }

  async function saveSpreadsheetAndRunTests() {
    indicateTestsRunning();
    clearErrorHighlights();

    const response = await fetch("/api/save-and-run", {
      method: "POST",
      body: JSON.stringify({
        "spreadsheet-data": jspreadsheetObj?.getData(),
        filename: currentFilePath,
        "spreadsheet-dimensions": getSpreadsheetDimensions(),
      }),
    });

    await handleTestResponse(response);
  }

  function openDetails(element) {
    const details = element.parentElement;
    if (details.tagName !== "DETAILS") return;
    details.open = true;
    openDetails(details);
  }

  function getSelectedTest() {
    const selectedTestId = localStorage.getItem("selected-test");
    if (!selectedTestId) {
      return;
    }

    const selectedTest = document.getElementById(selectedTestId);
    openDetails(selectedTest);
    handleTestSelection(selectedTest);
  }

  function setSelectedTest(id) {
    localStorage.setItem("selected-test", id);
  }

  function highlightSelectedTest(element) {
    const selectableElements = document.querySelectorAll("#menu-div details *");
    selectableElements.forEach(selectableElement => selectableElement.classList.remove("selected-test"));

    element.classList.add("selected-test");
  }

  async function getSpreadsheet(name) {
    const response = await fetch("/api/csv-read", {
      method: "POST",
      body: JSON.stringify({ filename: name }),
    });

    if (response.ok) {
      return await response.json();
    }
  }

  async function loadTestSpreadsheet(filePath) {
    const spreadsheet = await getSpreadsheet(filePath);

    const spreadsheetDOMElement = document.querySelector("#spread-spreadsheet");
    Array.from(spreadsheetDOMElement?.children)?.forEach(child => child.remove());
    displayTestStatusAlert("");

    loadJSpreadsheet(spreadsheet);
    currentFilePath = filePath;
  }

  async function handleTestSelection(htmlElement) {
    const filePath = htmlElement.getAttribute("file-path");
    await loadTestSpreadsheet(filePath);
    setSelectedTest(htmlElement.id);
    highlightSelectedTest(htmlElement);
  }

  function appendElementToMenu(menu, el, topLevel) {
    const { name, children, path } = el;
    if (children) {
      const details = document.createElement("details");

      const summary = document.createElement("summary");
      summary.textContent = name;
      summary.style.cursor = "pointer";
      summary.id = name + ".csv";

      details.appendChild(summary);
      menu.appendChild(details);

      if (!topLevel) {
        summary.setAttribute("file-path", "/" + path + ".csv");

        summary.addEventListener("click", (ev) => {
          if (ev.clientX > 23) {
            ev.preventDefault();
            handleTestSelection(summary);
          }
        });
      }
      children.forEach(el => appendElementToMenu(details, el, false));
    } else {
      const p = document.createElement("p");
      p.id = name;
      p.textContent = name.replace(".csv", "");
      p.style.cursor = "pointer";

      menu.appendChild(p);

      p.setAttribute("file-path", "/" + path);
      p.addEventListener("click", (_ev) => handleTestSelection(p));
    }
  }

  async function getTestTree() {
    const response = await fetch("/api/get-test-tree");
    return await response.json();
  }

  async function loadTestsTree() {
    const tree = await getTestTree();
    if (tree) {
      const menu = document.querySelector("#menu-div");
      menu.style.display = "block";
      tree.forEach(namespace => {
        appendElementToMenu(menu, namespace, true);
      });
      getSelectedTest();
    }
  }

  function replaceCtrlEnterWithAltEnter(ev) {
    if (ev.ctrlKey && ev.key === 'Enter') {
      ev.preventDefault();
      ev.stopPropagation();
      ev.target.dispatchEvent(new KeyboardEvent('keydown', { key: 'Enter', bubbles: true, altKey: true, which: 13 }));
    }
  }
  document.body.addEventListener('keydown', replaceCtrlEnterWithAltEnter);

  loadTestsTree();
  runTests();
</script>

</html>