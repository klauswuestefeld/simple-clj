<!DOCTYPE html>
<html lang="en" style="margin: 0px; padding: 0px; height: 100%">

<head>
  <meta charset="UTF-8" />
  <title>Twodee</title>

  <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
  <script src="https://jsuites.net/v4/jsuites.js"></script>
  <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
  <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />

  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Material+Icons" />
  <style>
    #twodee {
      margin: 12px;
    }

    details>*:not(summary) {
      margin-left: 1em;
    }

    details p {
      margin-top: 0.4rem;
      margin-bottom: 0.4rem;
    }

    p.selected-test {
      background-color: blue;
      color: white;
    }
  </style>
</head>

<body style="margin: 0px; padding: 0px; height: 100%;">
  <div id="menu-div" style="display: none; width: 350px; background-color: #f5f5f5; height: 100%; float: left;">
    <div id="button-container">
      <button id="save-spreadsheet-btn" onclick="saveSpreadsheetAndRunTests();">Save and Run Tests!</button>
    </div>
  </div>
  <div id="twodee-spreadsheet"></div>
</body>
<script>
  let jspreadsheetObj;
  let currentFilePath = null;

  function loadJSpreadsheet(spreadsheet) {
    const jspreadsheetPayload = {
      data: spreadsheet.data,
      onevent: function (event, a, b, c, d, e, f) {
        // console.log(event, a, b, c, d, e, f);
      },
      onopenworksheet: function (_worksheet, worksheetIndex) {
        removeTestStatusAlert();
      },
      oncreateworksheet: function (_event) {
        removeTestStatusAlert();
      },
      onchange: function (event) {
        saveSpreadsheetAndRunTests();
      },
      rowResize: true,
      wordWrap: true,
    }
    if (spreadsheet?.dimensions?.columns) {
      jspreadsheetPayload.columns = spreadsheet.dimensions.columns;
    }
    if (spreadsheet?.dimensions?.rows) {
      jspreadsheetPayload.rows = spreadsheet.dimensions.rows;
    }
    jspreadsheetObj = jspreadsheet(document.getElementById("twodee-spreadsheet"), jspreadsheetPayload);
  }

  function clearErrorHighlights() {
    const table = jspreadsheetObj.getData();
    for (let i = 0; i < table.length; i++) {
      for (let j = 0; j < table[i].length; j++) {
        const cellDOMElement = jspreadsheetObj.getCellFromCoords(j, i);
        cellDOMElement.style.backgroundColor = "white";
      }
    }
  }

  function displayTestStatusAlert(message, textColor) {
    const alert = document.createElement("p");
    alert.id = "test-status-alert";
    alert.textContent = message;

    if (textColor) {
      alert.style.color = textColor;
    }

    const container = document.querySelector("#button-container");
    container.appendChild(alert);
  }

  function removeTestStatusAlert() {
    const alert = document.querySelector("#test-status-alert");
    alert?.remove();
  }

  function alertTestsRunning() {
    removeTestStatusAlert();
    displayTestStatusAlert("Running tests...");
  }

  function alertTestsPassed() {
    removeTestStatusAlert();
    displayTestStatusAlert("All tests passed", "green");
  }

  async function handleTestResponse(response) {
    if (!response.ok) {
      removeTestStatusAlert();
      const jsonResponse = await response.json();
      if (jsonResponse["ex-data"]) {
        const cell = jsonResponse["ex-data"].column + jsonResponse["ex-data"].line;

        const spreadsheetElement = document.getElementById(jsonResponse["ex-data"].spreadsheet);
        await handleTestSelection(spreadsheetElement);

        const cellDOMElement = jspreadsheetObj.getCell(cell);
        cellDOMElement.style.backgroundColor = "lightpink";

        alert(jsonResponse.message + "\nCell " + cell);
      } else {
        alert(jsonResponse.message);
      }
    } else {
      setTimeout(() => alertTestsPassed(), 600);
    }
  }

  async function runTests() {
    alertTestsRunning();

    const response = await fetch("/api/run");
    await handleTestResponse(response);
  }

  function getSpreadsheetDimensions() {
    const columns = [];
    jspreadsheetObj.colgroup.forEach(col => columns.push({ width: Number(col.width) }));

    const rows = {};
    jspreadsheetObj.rows.forEach((row, i) => {
      const settedHeight = row.getAttribute('height');
      rows[i] = { height: settedHeight ? settedHeight + 'px' : '' };
    });

    return { columns, rows };
  }

  async function saveSpreadsheetAndRunTests() {
    alertTestsRunning();
    clearErrorHighlights();

    const response = await fetch("/api/save-and-run", {
      method: "POST",
      body: JSON.stringify({
        "spreadsheet-data": jspreadsheetObj?.getData(),
        filename: currentFilePath,
        "spreadsheet-dimensions": getSpreadsheetDimensions(),
      }),
    });

    await handleTestResponse(response);
  }

  function openDetails(element) {
    const details = element.parentElement;
    details.open = true;
    if (details.id !== "twodtest") {
      openDetails(details);
    }
  }

  function getSelectedTest() {
    const selectedTestId = localStorage.getItem("selected-test");
    if (!selectedTestId) {
      return;
    }

    const selectedTest = document.getElementById(selectedTestId);
    openDetails(selectedTest);
    selectedTest.click();
  }

  function setSelectedTest(id) {
    localStorage.setItem("selected-test", id);
  }

  function highlightSelectedTest(element) {
    const selectableElements = document.querySelectorAll("details p");
    selectableElements.forEach(selectableElement => selectableElement.classList.remove("selected-test"));

    element.classList.add("selected-test");
  }

  async function getSpreadsheet(name) {
    const response = await fetch("/api/csv-read", {
      method: "POST",
      body: JSON.stringify({ filename: name }),
    });

    if (response.ok) {
      const responseJson = await response.json();

      return responseJson;
    }
  }

  async function loadTestSpreadsheet(filePath) {
    const spreadsheet = await getSpreadsheet(filePath);

    const spreadsheetDOMElement = document.querySelector("#twodee-spreadsheet");
    Array.from(spreadsheetDOMElement?.children)?.forEach(child => child.remove());
    removeTestStatusAlert();

    loadJSpreadsheet(spreadsheet);
    currentFilePath = filePath;
  }

  function getMenuItemFilePath(element, path) {
    if (element.parentElement.id === "twodtest") {
      return path;
    }

    path = "/" + element.parentElement.id + path;

    return getMenuItemFilePath(element.parentElement, path);
  }

  async function handleTestSelection(element) {
    const filePath = element.getAttribute('file-path');
    await loadTestSpreadsheet(filePath);
    setSelectedTest(element.id);
    highlightSelectedTest(element);
  }

  function appendElementToMenu(menu, el) {
    const isDirectory = el.children;
    if (isDirectory) {
      const details = document.createElement("details");
      details.id = el.name;

      const summary = document.createElement("summary");
      summary.textContent = el.name;
      summary.style.cursor = "pointer";

      details.appendChild(summary);

      menu.appendChild(details);

      el.children.forEach(el => appendElementToMenu(details, el));
    } else {
      const p = document.createElement("p");
      p.id = el.name;
      p.textContent = el.name;
      p.style.cursor = "pointer";

      menu.appendChild(p);

      const filePath = getMenuItemFilePath(p, "/" + el.name);
      p.setAttribute("file-path", filePath);

      p.addEventListener("click", (_ev) => handleTestSelection(p));
    }
  }

  async function getTestTree() {
    const response = await fetch("/api/get-test-tree");
    return await response.json();
  }

  async function loadTestsTree() {
    const tree = await getTestTree();
    if (tree) {
      const menu = document.querySelector("#menu-div");
      menu.style.display = "block";
      appendElementToMenu(menu, tree);
      getSelectedTest();
    }
  }

  function overrideKeyDownControls() {
    jexcel.keyDownControls = function (e) {
      if (jexcel.current) {
        if (jexcel.current.edition) {
          if (e.which == 27) {
            // Escape
            if (jexcel.current.edition) {
              // Exit without saving
              jexcel.current.closeEditor(jexcel.current.edition[0], false);
            }
            e.preventDefault();
          } else if (e.which == 13) {
            // Enter
            if (jexcel.current.options.columns[jexcel.current.edition[2]].type == 'calendar') {
              jexcel.current.closeEditor(jexcel.current.edition[0], true);
            } else if (jexcel.current.options.columns[jexcel.current.edition[2]].type == 'dropdown' ||
              jexcel.current.options.columns[jexcel.current.edition[2]].type == 'autocomplete') {
              // Do nothing
            } else {
              // Alt enter -> do not close editor
              if ((jexcel.current.options.wordWrap == true ||
                jexcel.current.options.columns[jexcel.current.edition[2]].wordWrap == true ||
                jexcel.current.options.data[jexcel.current.edition[3]][jexcel.current.edition[2]].length > 200) && e.ctrlKey) {
                // Add new line to the editor
                var editorTextarea = jexcel.current.edition[0].children[0];
                var editorValue = jexcel.current.edition[0].children[0].value;
                var editorIndexOf = editorTextarea.selectionStart;
                editorValue = editorValue.slice(0, editorIndexOf) + "\n" + editorValue.slice(editorIndexOf);
                editorTextarea.value = editorValue;
                editorTextarea.focus();
                editorTextarea.selectionStart = editorIndexOf + 1;
                editorTextarea.selectionEnd = editorIndexOf + 1;
              } else {
                jexcel.current.edition[0].children[0].blur();
              }
            }
          } else if (e.which == 9) {
            // Tab
            if (jexcel.current.options.columns[jexcel.current.edition[2]].type == 'calendar') {
              jexcel.current.closeEditor(jexcel.current.edition[0], true);
            } else {
              jexcel.current.edition[0].children[0].blur();
            }
          }
        }

        if (!jexcel.current.edition && jexcel.current.selectedCell) {
          // Which key
          if (e.which == 37) {
            jexcel.current.left(e.shiftKey, e.ctrlKey);
            e.preventDefault();
          } else if (e.which == 39) {
            jexcel.current.right(e.shiftKey, e.ctrlKey);
            e.preventDefault();
          } else if (e.which == 38) {
            jexcel.current.up(e.shiftKey, e.ctrlKey);
            e.preventDefault();
          } else if (e.which == 40) {
            jexcel.current.down(e.shiftKey, e.ctrlKey);
            e.preventDefault();
          } else if (e.which == 36) {
            jexcel.current.first(e.shiftKey, e.ctrlKey);
            e.preventDefault();
          } else if (e.which == 35) {
            jexcel.current.last(e.shiftKey, e.ctrlKey);
            e.preventDefault();
          } else if (e.which == 32) {
            if (jexcel.current.options.editable == true) {
              jexcel.current.setCheckRadioValue();
            }
            e.preventDefault();
          } else if (e.which == 46) {
            // Delete
            if (jexcel.current.options.editable == true) {
              if (jexcel.current.selectedRow) {
                if (jexcel.current.options.allowDeleteRow == true) {
                  if (confirm(jexcel.current.options.text.areYouSureToDeleteTheSelectedRows)) {
                    jexcel.current.deleteRow();
                  }
                }
              } else if (jexcel.current.selectedHeader) {
                if (jexcel.current.options.allowDeleteColumn == true) {
                  if (confirm(jexcel.current.options.text.areYouSureToDeleteTheSelectedColumns)) {
                    jexcel.current.deleteColumn();
                  }
                }
              } else {
                // Change value
                jexcel.current.setValue(jexcel.current.highlighted, '');
              }
            }
          } else if (e.which == 13) {
            // Move cursor
            if (e.shiftKey) {
              jexcel.current.up();
            } else {
              if (jexcel.current.options.allowInsertRow == true) {
                if (jexcel.current.options.allowManualInsertRow == true) {
                  if (jexcel.current.selectedCell[1] == jexcel.current.options.data.length - 1) {
                    // New record in case selectedCell in the last row
                    jexcel.current.insertRow();
                  }
                }
              }

              jexcel.current.down();
            }
            e.preventDefault();
          } else if (e.which == 9) {
            // Tab
            if (e.shiftKey) {
              jexcel.current.left();
            } else {
              if (jexcel.current.options.allowInsertColumn == true) {
                if (jexcel.current.options.allowManualInsertColumn == true) {
                  if (jexcel.current.selectedCell[0] == jexcel.current.options.data[0].length - 1) {
                    // New record in case selectedCell in the last column
                    jexcel.current.insertColumn();
                  }
                }
              }

              jexcel.current.right();
            }
            e.preventDefault();
          } else {
            if ((e.ctrlKey || e.metaKey) && !e.shiftKey) {
              if (e.which == 65) {
                // Ctrl + A
                jexcel.current.selectAll();
                e.preventDefault();
              } else if (e.which == 83) {
                // Ctrl + S
                jexcel.current.download();
                e.preventDefault();
              } else if (e.which == 89) {
                // Ctrl + Y
                jexcel.current.redo();
                e.preventDefault();
              } else if (e.which == 90) {
                // Ctrl + Z
                jexcel.current.undo();
                e.preventDefault();
              } else if (e.which == 67) {
                // Ctrl + C
                jexcel.current.copy(true);
                e.preventDefault();
              } else if (e.which == 88) {
                // Ctrl + X
                if (jexcel.current.options.editable == true) {
                  jexcel.cutControls();
                } else {
                  jexcel.copyControls();
                }
                e.preventDefault();
              } else if (e.which == 86) {
                // Ctrl + V
                jexcel.pasteControls();
              }
            } else {
              if (jexcel.current.selectedCell) {
                if (jexcel.current.options.editable == true) {
                  var rowId = jexcel.current.selectedCell[1];
                  var columnId = jexcel.current.selectedCell[0];

                  // If is not readonly
                  if (jexcel.current.options.columns[columnId].type != 'readonly') {
                    // Characters able to start a edition
                    if (e.keyCode == 32) {
                      // Space
                      if (jexcel.current.options.columns[columnId].type == 'checkbox' ||
                        jexcel.current.options.columns[columnId].type == 'radio') {
                        e.preventDefault();
                      } else {
                        // Start edition
                        jexcel.current.openEditor(jexcel.current.records[rowId][columnId], true);
                      }
                    } else if (e.keyCode == 113) {
                      // Start edition with current content F2
                      jexcel.current.openEditor(jexcel.current.records[rowId][columnId], false);
                    } else if ((e.keyCode == 8) ||
                      (e.keyCode >= 48 && e.keyCode <= 57) ||
                      (e.keyCode >= 96 && e.keyCode <= 111) ||
                      (e.keyCode >= 187 && e.keyCode <= 190) ||
                      ((String.fromCharCode(e.keyCode) == e.key || String.fromCharCode(e.keyCode).toLowerCase() == e.key.toLowerCase()) && jexcel.validLetter(String.fromCharCode(e.keyCode)))) {
                      // Start edition
                      jexcel.current.openEditor(jexcel.current.records[rowId][columnId], true);
                      // Prevent entries in the calendar
                      if (jexcel.current.options.columns[columnId].type == 'calendar') {
                        e.preventDefault();
                      }
                    }
                  }
                }
              }
            }
          }
        } else {
          if (e.target.classList.contains('jexcel_search')) {
            if (jexcel.timeControl) {
              clearTimeout(jexcel.timeControl);
            }

            jexcel.timeControl = setTimeout(function () {
              jexcel.current.search(e.target.value);
            }, 200);
          }
        }
      }
    }
  }

  loadTestsTree();
  overrideKeyDownControls();
  runTests();
</script>

</html>